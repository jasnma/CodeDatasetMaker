# C语言代码分析工具开发总结

## 项目目标

开发一个能够自动分析C语言项目的工具，提取以下信息：
1. 函数调用关系图
2. 结构体定义和使用情况
3. 宏定义和使用情况
4. 全局变量定义和使用情况

## 主要功能实现

### 1. 函数调用图生成
- 使用Clang Python绑定(libclang)解析C代码
- 构建完整的函数调用关系图
- 支持跨文件函数调用分析
- 生成JSON格式的调用图和文本树视图

### 2. 结构体信息提取
- 识别各种形式的结构体定义
- 提取结构体字段信息（名称和类型）
- 记录结构体使用位置
- 支持复杂结构体（嵌套、指针、数组等）

### 3. 宏信息处理
- 提取宏定义
- 记录宏使用位置
- 处理复杂的宏定义模式

### 4. 全局变量追踪
- 识别全局变量定义
- 追踪全局变量使用位置

## 关键技术突破

### 1. 复杂结构体处理
成功解决了多种复杂结构体的识别问题：

#### 匿名结构体处理
通过多层方法识别匿名结构体的真实名称：
1. 语义父节点检查
2. 词法父节点检查
3. AST遍历查找（核心创新）
4. 源代码解析
5. 备选方案

#### 宏开关条件编译结构体
针对如下形式的结构体：
```c
typedef struct {
#if CONFIG_BYTE_ORDER == CPU_BIG_ENDIAN
    uint32_t    high;
    uint32_t    low;
#else
    uint32_t    low;
    uint32_t    high;
#endif
} j_uint64_t;
```

通过AST遍历查找方法，成功识别出`j_uint64_t`结构体及其字段。

### 2. 跨平台兼容性
- 支持Windows、macOS和Linux系统
- 自动检测和配置libclang路径

### 3. 项目文件解析
- 支持Keil项目文件(.uvproj/.uvprojx)
- 支持Eclipse CDT项目文件(.cproject)
- 自动提取包含路径

## 测试验证

通过多个测试用例验证工具的正确性：
1. 基本结构体处理测试
2. 复杂结构体处理测试
3. 宏开关条件编译结构体测试
4. 综合案例测试

所有测试均通过，证明工具能够正确处理各种复杂情况。

## 输出格式

工具生成以下JSON文件：
1. `call_graph.json` - 函数调用图
2. `struct_info.json` - 结构体信息
3. `macro_info.json` - 宏信息
4. `global_var_info.json` - 全局变量信息
5. `file_info.json` - 文件信息
6. `global_project_text_tree.txt` - 文本格式的调用树

## 使用方法

```bash
python3 c_graph.py <project_directory>
```

## 总结

本项目成功开发了一个功能完整的C语言代码分析工具，具有以下特点：
1. 能够处理各种复杂的C语言结构
2. 准确识别宏开关条件编译的结构体
3. 提供丰富的代码结构信息
4. 良好的跨平台兼容性
5. 易于使用的命令行接口

该工具可广泛应用于代码分析、重构、文档生成等场景。
